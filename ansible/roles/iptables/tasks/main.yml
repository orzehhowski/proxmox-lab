- name: Turn on ipv4 packet forwarding
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes

- name: Install iptables-persistent
  apt:
    name: iptables-persistent
    state: present
    update_cache: yes

- name: Put iptables rules file
  template:
    src: rules.v4.j2
    dest: /etc/iptables/rules.v4
    owner: root
    group: root
    mode: 0644
  notify:
    - Apply iptables rules
    - Save iptables rules

- name: Ensure the iptables-persistent service is running
  systemd:
    name: netfilter-persistent
    enabled: yes
    state: started
  become: true
